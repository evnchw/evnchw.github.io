---
title: "Werner, Sam, et al. \"Sok: Decentralized finance (defi).\" Proceedings of the 4th ACM Conference on Advances in Financial Technologies. 2022."
collection: notes
type: "Post"
permalink: /notes/20240804_werner_2022_sok
date: 2024-08-04
---

**Abstract**

```
Decentralized Finance (DeFi), a blockchain powered peer-to-peer financial system, is mushrooming. Two years ago the total value locked in DeFi systems was approximately 700m USD, now, as of April 2022, it stands at around 150bn USD. The frenetic evolution of the ecosystem has created challenges in understanding the basic principles of these systems and their security risks. In this Systematization of Knowledge (SoK) we delineate the DeFi ecosystem along the following axes: its primitives, its operational protocol types and its security. We provide a distinction between technical security, which has a healthy literature, and economic security, which is largely unexplored, connecting the latter with new models and thereby synthesizing insights from computer science, economics and finance. Finally, we outline the open research challenges in the ecosystem across these security types.
```

  - **Citations**: 347
  - **Research objective**: Propose a classification for the DEFI ecosystem by protocol types and their security.
  - **Key notes**:
    - both audited and unaudited smart contracts pose technical risks
    - *atomicity* property of smart contracts: immediately succeed or fail
    - review, execution of a transaction:
      - create or reuse smart contract
      - broadcast transaction to peers (mempool) who validate the transaction
      - transaction and its associated transaction fee (gas fee) goes into a queue for mining
      - miners choose to add these transactions to the public ledger via a "mining" process
        - solve mathematical cryptographic puzzle --> that new block gets added to the ledger (blockchain)
      - however this has now moved to "proof of stake"
    - entities and roles
      - keepers: programs that automatically keep the blockchain up to date (e.g. trigger and write transactions such as liquidating collateral)
      - oracles: components to ingest external data into the blockchain (e.g. for synthetic tokens)
      - governance:
        - usually starts with the protocol creators (small council "multisig") who promise to eventually decentralize the governance
        - governance decentralized via governance tokens 
        - majority voting on protocol updates, etc.
    - DEFI protocols
      - On-chain asset exchange
      - Loanable fund markets for on-chain assets
        - overcollateralized loans
        - flash loans - prone to attacks
      - Stablecoins
        - don't include *custodial* stablecoins (USDT) which are managed by centralized third-party
        - how do you achieve price stability for on-chain stablecoins?
      - Portfolio management
    - a side note on yield: rewards you earn from providing liquidity or stability to these decentralized protocols
      - lending protocols: yield = interest rates from lending out your assets to provide liquidity
      - stakers: if you lock up your tokens in proof-of-stake you can earn rewards
      - liquidity providers: if you provide liquidity for decentralized exchanges
      - incentive programs for new protocols: if you sign up
      - yield farming and why it is controversial: providing liquidity to protocols is risky for many reasons. for one, both the asset you lock up (specifically its exchange rate with the protocol's native token) and the reward tokens you receive can be highly volatile. ponzi-like criticism, in that rewards for users are based on new user entry and growth. also, rug pulls: original developers may withdraw all the liquidity shortly after release, leaving the user with worthless tokens. lastly: risks for money laundering and illicit activities.
    - Derivatives
      - Synthetic assets: tokenized version of off-chain instruments
      - Perpetual swaps: like futures but never expire.
        - you can hold as long as you want, as long as you hold required margin.
          - this let you do leverage: put down 10% of a (X BTC) position.
          - at a later time you can buy (sell) that much.
        - periodic funding rate mechanisms implemented at the level of exchanges: compare the perpetual swap contract price & spot, and if there is imbalance then swap buyers (long positions) pay a rebalancing amount, the "funding rate," to the swap sellers (short positions).
      - Privacy-preserving mixers
        - mix coins together to preserve privacy (could shield illicit activity)
    - Definition of an exploit:
      - consider the difference at time T between the smart contract's off-chain estimates and the true off-chain economic ground truth, given the filtration of information up to that point
        - 1. exploiting intended vs. actual implementation of smart contract (e.g. bugs)
        - 2. exploiting that informational gap at time T
        - 3. creating that information gap at time T
      - intention matters however. In the AMM mechanism, it is okay if the price deviates as to let arbitrageurs close the gap.
    - Technical security exploit
      - Definition: attacker can atomically exploit a protocol
      - "risk free" - either works or not (paying gas fees).
      - often occur in a single transaction or single block of transactions
    - Smart contract vulnerabilities
      - Reentrancy: functions can be called repeatedly before as the system state is only partially modified (especially if prioritized via higher gas fees). This caused the big DAO hack: repeated withdraw.
      - Integer manipulation: protocols can only check integer precision (overflow or underflow) to a certain extent
      - Logic bugs in smart contracts
    - Single transaction attacks
      - Governance tokens are a point of risk.
        - Attackers can atomically (instantaneously, within the same transaction) gain enough governance tokens via flash loans, make changes, then commit
      - Single transaction sandwich attacks
        - Create imbalance in AMM --> exploit (composable) contracts that rely on the price --> reverse the imbalance, all within the same (atomic) transaction
        - Example: Harvest. (1) $50m USDT flash loan from Harvest --> (2) use funds to create liquidity imbalance via manipulating on Curve (an AMM) and increase price of USDT --> (3) Curve was an on-chain oracle for Harvest, so Harvest sees a USDT price increase --> (4) attacker deposits USDT to "help" this in exchange for Harvest liquidity-provider tokens --> (5) lastly, reverse the imbalance on Curve and withdraw USDT.
    - Transaction ordering attacks
      - Front-running / back-running: transactions prioritized by gas fees, so can exploit by setting gas fees to time your transactions (risk-free if you are a miner)
      - Displacement attacks
        - front-run another later transaction (not depending on its execution)
        - example: bug-bounty, or front-running transaction that is trying to rescue funds
      - Multi-transaction sandwich attacks
        - Manipulating price via changing imbalance on AMMs
        - Example: "sandwich" another user's transaction
          - front-run with a high gas fee
          - back-run with a low gas fee
        - Note: ultimately depends on transaction's miner to set order, so not guaranteed
        - Can also be done from the liquidity provider's side, withdrawing (front-running) then resupplying liquidity
    - Economic security exploits
      - Non-atomic exploits, so not risk-free and only probabilistic.
      - Example: say AMM depends on an oracle. Could manipulate it instantly (atomic attack) or over time, esp. if oracle say depends on some time window.
      - Economic security only makes sense if technical security is first achieved.
      - Rational agents: profit optimizing (will never play a strictly worse strategy).
      - Incentive compatibility: agents are incentivized to execute the game as originally intended by the mechanism designer.
    - Overcollateralization as security
      - Recall: automatic deleveraging (if collateral falls below % threshold against the principal, then begins being auctioned off)
      - Deleveraging risks
        - One way: negative shocks to collateral asset --> can reduce its value and so undercollateralization / deleveraging can happen organically
        - This is a big question to me: how do you ensure stability for (over-)collateral? Especially given there are not that many proven crypto derivatives yet (just perpetual swaps, some basic options, etc.)
        - Another way: endogenous risk. How do you make sure that collateralization actions of agents don't impact each others' collateral value?
          - Example: every agent puts up some ETH collateral to borrow DAI --> this will drive down the value of ETH (at least directly with respect to DAI and possibly indirectly with respect to other currencies)
          - Risk of deleveraging feedback effects. Example: DAI black thursday in early 2020 when crypto asset values fell dramatically. (uncertainty --> no room for speculative assets: "risk-off")
          - There is a potential application of MFG here, at the level of one or multiple protocols: everyone puts up collateral to maintain the value of what they can borrow, yet doing so drives the price of everyone's collateral. How do you optimize against that overall trajectory?
      - Miner extractable value (MEV) threats
        - miners not always incentivized to act in public interest
        - especially because can choose the order of mining transactions
        - undercutting
          - say you have blocks 1-6 that require validation on the ledger by miners
          - one adversarial miner sees block 5 has high expected value, "forks" from there and starts mining that and gets other miners to join in
          - eventually block 5 becomes the continuation of the new blockchain
        - time-bandit attacks
          - like undercutting (forking from previous block), but based on expected MEV and pursue a 51% layer attack until the fork becomes the main chain
        - Other forms of miner collusion
      - Governance risks
        - Governance tokens = like shares in the protocol
        - Incentives should ideally come from improvements and appreciation of the protocol assets over time (so you have incentive to govern well), say future discounted cashflows
        - Governance extractable value (GEV): value from behaviors that are helpful to the governors but not to the protocol and (non-governor) users
        - Risk: you can buy governance tokens on the open market sometimes, so if you take out a flash loan to buy those and immediately change the protocol and repay the loan, that can be a governance attack
      - Market and oracle manipulation
        - AMMs are highly manipulable and should not be used as oracles.
        - In the case of lending, collateral (say locked-up ETH) may use oracles (say for ETH exchange rates) to track the collateralization value. If there is bug or manipulation on those oracles that induces a negative price movement in the collateral value, this may trigger a sell-off and negative feedback cycles thereafter.
          - Prior to the liquidation, attackers could benefit from a short position (a priori) or a discount purchase of the liquidated collateral (ex post).
      - Incentives tied to consensus are risky if the consensus is modified.
      - Other open questions:
        - How can stablecoins achieve true stability?
        - How can protocols achieve incentive compatibility for governance?
        - How do miners optimize their miner-extracted value?
        - How do GEV and MEV endogenously affect the behavior of these systems?
        - How do we analyze programs and protocols for technical correctness, formally?
  - **Overall impression**:
    - A useful survey of technical and economic risks in DeFi protocols.
